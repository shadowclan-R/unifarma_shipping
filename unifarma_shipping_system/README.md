# unifarma_shipping
نظرة عامة على المعمارية
1. مشروع Django الرئيسي
قم بإنشاء مشروع Django رئيسي (لنسمّه مثلًا unifarma_shipping). سيتضمن هذا المشروع إعدادات الإعداد (settings) العامة، وإعدادات قواعد البيانات، وإدارة المستخدمين والصلاحيات الأساسية.

2. تطبيق إدارة التكامل مع الـ CRM
اسم التطبيق: crm_integration.
المسؤوليات:
التكامل مع منظومة الـ CRM (سواء واجهات API أو Webhooks).
جلب الصفقات التي وصل حالتها إلى "تم الشحن مع الشركة".
استخراج قيم الحقول اللازمة مثل: "شركة الشحن" و"الدولة" و"بيانات الشحنة" وغيرها.
إمكانية تصنيف أو ترجمة بيانات الـ CRM إلى هيكلية مفهومة للتطبيق.
للتكامل مع الـ CRM، يمكن الاعتماد على:

Webhooks: يتم استدعاؤها من منظومة الـ CRM عند تغيير حالة الصفقة إلى "تم الشحن مع الشركة".
REST API: إجراء استعلامات دورية للحصول على الصفقات التي في الحالة المطلوبة.
3. تطبيق إدارة شركات الشحن والحسابات
اسم التطبيق: shippers.
المسؤوليات:
إدارة معلومات شركات الشحن المختلفة (على سبيل المثال: ناقل، سمسا، DHL، إلخ).
إدارة الحسابات المحددة لكل شركة (مثال: حساب ناقل دولي، حساب ناقل داخلي…إلخ).
ضبط الدولة أو نطاق الدول المرتبطة بكل حساب من حسابات الشحن. يمكن الاعتماد على جدول يحتوي على حقول مثل:
company_name
account_title (مثال: "ناقل-داخلي", "ناقل-دولي")
country_code_list (قائمة بأكواد الدول؛ إن كانت للشحن الدولي يمكن وضعها فارغة أو منطق معين)
api_credentials (يحتوي مفاتيح وخانات الدخول لكل حساب)
4. تطبيق إدارة الطلبات والشحنات
اسم التطبيق: orders.
المسؤوليات:
بيانات الطلب/الصفقة التي تأتي من الـ CRM (رقم التتبع، تفاصيل العميل، المنتجات).
منطق تحديد شركة الشحن المناسبة (بناءً على الدولة أو نوع الشحن المطلوب).
إرسال الطلب إلى API شركة الشحن المختارة مع إعداد تهيئة الطلب (Request Body) كما هو مناسب لكل شركة.
تحديث حالة الشحنة وردود الـ API من شركات الشحن، مع حفظ أية بيانات مطلوبة (مثل رقم التتبع Tracking Number، حالة الشحنة… إلخ).
لتفادي الارتباط المباشر بين نظامنا وجميع شركات الشحن، يُنصح باستخدام نمط التصميم "Adapter Pattern" أو "Strategy Pattern":

لكل شركة شحن Adapter أو Strategy خاص يعالج عمليات الارتباط بتلك الشركة (مثلًا NaqelAdapter, SMSAAdapter, DHLAdapter …إلخ).
يتحمل الـ Adapter منطق التعامل مع كل شركة شحن (تنسيق بيانات الطلب، استدعاء الـ API، معالجة الاستجابات).
5. طبقة الخدمات (Services Layer)
ضمن كل تطبيق أو كتطبيق خدمات منفصل، يمكن إضافة خدمات (Services) لتجهيز كل الطلبات وعمليات الإرسال بشكل أفضل. على سبيل المثال: ShipmentService يقوم بالتالي:

يستقبل معلومات الطلب (الدولة، العناصر… إلخ).
يحدد الحساب المناسب من قاعدة البيانات (باستناد إلى الدولة أو نوع الشحنة).
يستدعي الـ Adapter الخاص بالشركة مع تمرير بيانات الـ API.
6. الأمان (Security) وبيانات الاعتماد (Credentials)
الحفاظ على مفاتيح الـ API (مثل passkey, API key, secret) في إعدادات مشفرة أو في مدير أسرار (Secrets Manager) لضمان حمايتها وعدم إفشائها في الكود المصدري.
استخدام بروتوكول HTTPS لجميع الطلبات المتبادلة مع شركات الشحن وCRM.
7. قواعد البيانات
باستخدام أي محرك قواعد بيانات تدعمه Django (PostgreSQL يُنصح به لإنتاجية عالية)، يمكننا بناء الجداول التالية على الأقل:

Deal أو Order: جدول يحتفظ بالمعلومات الأساسية للصفقة/الطلب الوافد من الـ CRM (مع مفاتيح ربط للدول والعميل… إلخ).
ShippingCompany: جدول للشركات (Naqel, SMSA, …إلخ).
ShippingCompanyAccount: جدول لحسابات كل شركة (مع تخزين بيانات الدخول والمناطق/الدول المشمولة).
Shipment: جدول يحتفظ ببيانات الشحنة التي أُرسلت لشركات الشحن (تحديث الحالة، رقم التتبع… إلخ).
8. أفضل الممارسات (SOLID، Clean Code، Design Patterns)
Single Responsibility Principle (SRP): فصل مسؤولية التعامل مع كل شركة شحن في كلاس Adapter/Strategy مستقل.
Open/Closed Principle (OCP): بإمكاننا إضافة شركات شحن جديدة عبر إضافة Adapter جديد دون تعديل كبير في النواة الأساسية.
SOLID عمومًا لمزيد من المرونة والاختبارية (Testability).
Clean Code: تبسيط واجهات الدوال، استخدام أسماء واصفة للمتغيّرات والدوال، وتجنب تكديس المنطق في مكان واحد.
Design Patterns: بجانب الـ Adapter/Strategy، قد نستخدم Factory لاختيار شركة الشحن المناسبة بناءً على الدولة أو نوع الشحن.
9. الاختبار (Testing)
Unit Tests: لاختبار وحدات الشيفرة (Adapters, Services, Models).
Integration Tests: لاختبار التكامل الفعلي مع واجهات الـ CRM وخدمات شركات الشحن.
CI/CD: توظيف أنظمة التكامل المستمر (مثل GitLab CI أو GitHub Actions) لتنفيذ الاختبارات تلقائيًا، ثم النشر المستمر (Continuous Deployment) أو شبه المستمر (Continuous Delivery).
10. الخطوات القادمة
بناء نموذج (Proof of Concept) لجزئية ناقل (Naqel) أولًا كاختبار مبدئي.
ربطه بآلية سحب الصفقات من الـ CRM (سواءً عبر Webhooks أو Job Scheduler).
بعد نجاح ذلك سيتم إدراج باقي شركات الشحن، وتفعيل الحسابات المناسبة داخليًا أو دوليًا وفق إعدادات ShippingCompanyAccount.