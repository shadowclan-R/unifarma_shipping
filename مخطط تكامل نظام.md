# مخطط تكامل نظام Unifarma مع Bitrix24 و SMSA

## رسم توضيحي للتكامل

+---------------------+ +----------------------+ +--------------------+
| | | | | |
| Bitrix24 CRM +------>+ Unifarma Shipping +------>+ SMSA STAX API |
| | | System | | |
+---------------------+ +----------------------+ +--------------------+
^ | |
| | |
| v v
+---------------------+ +----------------------+ +--------------------+
| | | | | |
| Bitrix24 Webhooks | | Database (SQLite) | | Tracking Updates |
| | | | | |
+---------------------+ +----------------------+ +--------------------+


## تدفق البيانات

### 1. من Bitrix24 إلى Unifarma Shipping System

#### طريقة 1: استعلام مباشر (Pull)

1. **جدولة مهمة دورية** يقوم بها النظام للاستعلام عن الصفقات الجديدة في مرحلة "تم الشحن مع الشركة".
2. **استدعاء Bitrix24 API**:
   - `crm.deal.list`: للحصول على قائمة الصفقات في مرحلة الشحن
   - `crm.deal.get`: للحصول على تفاصيل كل صفقة
   - `crm.deal.productrows.get`: للحصول على منتجات الصفقة
   - `crm.deal.contact.items.get`: للحصول على معرف جهة الاتصال
   - `crm.contact.get`: للحصول على بيانات جهة الاتصال
3. **تخزين البيانات** في قاعدة بيانات النظام كطلبات جديدة.

#### طريقة 2: الاستجابة للأحداث (Push via Webhooks)

1. **إعداد Webhook في Bitrix24** للإشعار عند تغيير حالة الصفقة إلى مرحلة الشحن.
2. **استقبال الإشعار** من خلال نقطة نهاية Webhook في النظام.
3. **استعلام Bitrix24 API** للحصول على بيانات الصفقة الكاملة.
4. **تخزين البيانات** في قاعدة بيانات النظام كطلبات جديدة.

### 2. من Unifarma Shipping System إلى SMSA

#### إرسال طلب شحن

1. **معالجة الطلب**:
   - تحديد شركة الشحن المناسبة (SMSA)
   - تحديد الحساب المناسب (داخلي/دولي) بناءً على الدولة
   - معالجة رقم الهاتف حسب الدولة (9 أرقام للبحرين وقطر والكويت، 8 أرقام للدول الأخرى)
   - تحديد معرف المستودع (WrhId) المناسب
   - تحديد SKUs المناسبة للمنتجات
2. **إنشاء طلب شحن** من خلال استدعاء SMSA API:
   - نقطة النهاية: `POST /api/FulfilmentOrder`
   - إرسال بيانات الطلب مع:
     - بيانات الاعتماد (passkey)
     - بيانات العميل
     - بيانات المنتجات (SKUs)
     - العنوان والدولة
     - معرف المستودع (WrhId)
     - استخدام معرف الصفقة (IDdeal) كـ PNO
3. **تخزين استجابة SMSA** في قاعدة البيانات:
   - رقم التتبع
   - حالة الطلب
   - أي معلومات إضافية

#### تتبع حالة الشحنة

1. **استعلام دوري** عن حالة الشحنات النشطة.
2. **استدعاء SMSA API** للتتبع:
   - نقطة النهاية: `GET /api/Tracking`
   - إرسال معلمات التتبع (passkey ورقم التتبع)
3. **تحديث حالة الشحنة** في قاعدة البيانات.
4. **تنبيه المستخدمين** عند تغيير حالة الشحنة.

## التعامل مع المعرفات والأرقام

### معرفات المنتجات (SKUs)

1. **تخزين SKUs** في جدول `ProductSKUMapping` بقاعدة البيانات.
2. **تعيين SKUs** حسب الدولة:
   - SKU SMSA KSA: للسعودية
   - SKU SMSA UAE: للإمارات
   - SKU SMSA Jordan: للأردن
3. **الاسترجاع التلقائي** للـ SKU المناسب عند إنشاء طلب شحن.

### معرفات المستودعات (Warehouse IDs)

1. **تخزين معرفات المستودعات** في جدول `WarehouseMapping` بقاعدة البيانات.
2. **تعيين معرفات المستودعات** حسب الدولة ونوع الحساب (داخلي/دولي/بضائع).
3. **الاسترجاع التلقائي** لمعرف المستودع المناسب عند إنشاء طلب شحن.

### أرقام الهاتف

1. **معالجة أرقام الهاتف**:
   - إزالة رمز الدولة (+ أو 00) من جميع الأرقام
   - البحرين وقطر والكويت: إضافة 0 في البداية للوصول إلى 9 أرقام
   - باقي الدول: الاحتفاظ بـ 8 أرقام

## إعدادات التكامل

### إعدادات Bitrix24

1. **مفاتيح API** المخزنة في ملف `.env`:
   - `BITRIX_DEAL_FIELDS_URL`
   - `BITRIX_DEAL_LIST_URL`
   - `BITRIX_DEAL_GET_BASE_URL`
   - `BITRIX_DEAL_PRODUCT_ROWS_URL`
   - `BITRIX_DEAL_CONTACT_ITEMS_URL`
   - `BITRIX_CONTACT_GET_URL`
   - `BITRIX_USER_GET_URL`
   - `BITRIX_STAGE_LIST_URL`

2. **تكوين Webhook** (للطريقة الثانية):
   - URL: `https://your-domain.com/webhooks/citrix/`
   - الأحداث: `ONCRMDEALUPDATE`

### إعدادات SMSA

1. **مفاتيح API** المخزنة في ملف `.env`:
   - `SMSA_API_BASE_URL`
   - `SMSA_PASSKEY`

2. **تكوين حسابات SMSA**:
   - حسابات متعددة حسب نوع الشحن (داخلي/دولي)
   - معرفات المستودعات لكل دولة

## آلية المزامنة

### مزامنة الصفقات من Bitrix24

- **مهمة مجدولة** تعمل كل 15 دقيقة لسحب الصفقات الجديدة
- **Webhook** للاستجابة المباشرة لتغييرات الصفقات

### مزامنة حالة الشحنات مع SMSA

- **مهمة مجدولة** تعمل كل 30 دقيقة لتحديث حالة الشحنات النشطة

-------------------------------------------------------------------------------------

# خطة اختبار نظام تكامل شركات الشحن لـ Unifarma

## 1. اختبارات الوحدة (Unit Tests)

### 1.1 اختبار محول SMSA

- **الهدف**: التحقق من صحة عمل محول SMSA مع واجهة برمجة التطبيقات (API).
- **الأدوات**: وحدة اختبار Django.
- **الاختبارات**:

| رقم الاختبار | وصف الاختبار | المدخلات | النتيجة المتوقعة |
|-------------|-------------|---------|-----------------|
| UT-SM-01 | تنسيق أرقام الهاتف | أرقام هواتف مختلفة مع رموز دول | أرقام مُنسقة حسب الدولة |
| UT-SM-02 | الحصول على SKU المنتج | معرفات منتجات مختلفة | SKUs مناسبة حسب الدولة |
| UT-SM-03 | الحصول على معرف المستودع | دول مختلفة | معرفات مستودعات مناسبة |
| UT-SM-04 | إنشاء شحنة | بيانات شحنة صحيحة | استجابة نجاح مع رقم تتبع |
| UT-SM-05 | إنشاء شحنة مع بيانات ناقصة | بيانات شحنة ناقصة | استجابة خطأ |

### 1.2 اختبار خدمة Bitrix24

- **الهدف**: التحقق من صحة التكامل مع Bitrix24 API.
- **الأدوات**: وحدة اختبار Django مع Mock للاستجابات.
- **الاختبارات**:

| رقم الاختبار | وصف الاختبار | المدخلات | النتيجة المتوقعة |
|-------------|-------------|---------|-----------------|
| UT-BX-01 | جلب قائمة الصفقات | معرفات مراحل الشحن | قائمة صفقات |
| UT-BX-02 | جلب تفاصيل الصفقة | معرف صفقة | بيانات الصفقة كاملة |
| UT-BX-03 | جلب منتجات الصفقة | معرف صفقة | قائمة منتجات الصفقة |
| UT-BX-04 | جلب بيانات العميل | معرف صفقة | بيانات العميل |
| UT-BX-05 | بناء بيانات الصفقة المنسقة | بيانات صفقة | كائن منسق بجميع البيانات اللازمة |

## 2. اختبارات التكامل (Integration Tests)

### 2.1 تكامل Bitrix24 مع النظام

- **الهدف**: التحقق من صحة استيراد الصفقات من Bitrix24 إلى النظام.
- **الأدوات**: اختبارات تكامل Django مع قاعدة بيانات اختبار.
- **الاختبارات**:

| رقم الاختبار | وصف الاختبار | المدخلات | النتيجة المتوقعة |
|-------------|-------------|---------|-----------------|
| IT-BX-01 | استيراد صفقة جديدة | معرف صفقة جديدة | إنشاء طلب جديد في النظام |
| IT-BX-02 | تحديث صفقة موجودة | معرف صفقة موجودة مع تغييرات | تحديث الطلب الموجود |
| IT-BX-03 | معالجة Webhook | بيانات webhook | معالجة الحدث وتحديث النظام |
| IT-BX-04 | استيراد منتجات الصفقة | معرف صفقة | إنشاء عناصر الطلب |

### 2.2 تكامل النظام مع SMSA

- **الهدف**: التحقق من صحة إرسال طلبات الشحن إلى SMSA.
- **الأدوات**: اختبارات تكامل Django مع Mock لاستجابات SMSA API.
- **الاختبارات**:

| رقم الاختبار | وصف الاختبار | المدخلات | النتيجة المتوقعة |
|-------------|-------------|---------|-----------------|
| IT-SM-01 | إنشاء شحنة لطلب | طلب جديد | إنشاء شحنة وإرسالها إلى SMSA |
| IT-SM-02 | تتبع شحنة | شحنة موجودة | تحديث حالة الشحنة |
| IT-SM-03 | اختيار حساب SMSA المناسب | طلب لدولة معينة | اختيار الحساب المناسب |
| IT-SM-04 | معالجة خطأ SMSA | استجابة خطأ | تسجيل الخطأ وعدم إكمال الشحنة |

## 3. اختبارات النظام (System Tests)

### 3.1 دورة حياة الطلب الكاملة

- **الهدف**: التحقق من سير العمل الكامل من استلام الصفقة إلى تتبع الشحنة.
- **الأدوات**: اختبارات النظام مع بيئة تجريبية كاملة.
- **الاختبارات**:

| رقم الاختبار | وصف الاختبار | المدخلات | النتيجة المتوقعة |
|-------------|-------------|---------|-----------------|
| ST-01 | دورة حياة طلب - السعودية | صفقة جديدة للسعودية | استيراد الصفقة، إنشاء طلب، إرسال شحنة، تتبع الشحنة |
| ST-02 | دورة حياة طلب - الإمارات | صفقة جديدة للإمارات | استيراد الصفقة، إنشاء طلب، إرسال شحنة، تتبع الشحنة |
| ST-03 | دورة حياة طلب - البحرين | صفقة جديدة للبحرين | استيراد الصفقة، إنشاء طلب، إرسال شحنة، تتبع الشحنة |
| ST-04 | دورة حياة طلب - الأردن | صفقة جديدة للأردن | استيراد الصفقة، إنشاء طلب، إرسال شحنة، تتبع الشحنة |

### 3.2 معالجة الحالات الخاصة

- **الهدف**: التحقق من قدرة النظام على معالجة الحالات الخاصة.
- **الأدوات**: اختبارات النظام مع بيئة تجريبية كاملة.
- **الاختبارات**:

| رقم الاختبار | وصف الاختبار | المدخلات | النتيجة المتوقعة |
|-------------|-------------|---------|-----------------|
| ST-SP-01 | معالجة صفقة بدون منتجات | صفقة بدون منتجات | تسجيل خطأ وعدم إكمال الشحنة |
| ST-SP-02 | معالجة صفقة بدون عنوان | صفقة بدون عنوان | تسجيل خطأ وعدم إكمال الشحنة |
| ST-SP-03 | معالجة صفقة بدون رقم هاتف | صفقة بدون رقم هاتف | تسجيل خطأ وعدم إكمال الشحنة |
| ST-SP-04 | معالجة صفقة مع دولة غير مدعومة | صفقة لدولة غير مدعومة | تسجيل خطأ وعدم إكمال الشحنة |

## 4. اختبارات أمان (Security Tests)

### 4.1 حماية البيانات الحساسة

- **الهدف**: التحقق من حماية البيانات الحساسة في النظام.
- **الأدوات**: فحص الكود ومراجعة الإعدادات.
- **الاختبارات**:

| رقم الاختبار | وصف الاختبار | المدخلات | النتيجة المتوقعة |
|-------------|-------------|---------|-----------------|
| SEC-01 | تخزين مفاتيح API | فحص ملفات الإعدادات | عدم ظهور المفاتيح في الكود المصدري |
| SEC-02 | حماية واجهات API | استدعاء API بدون مصادقة | رفض الوصول |
| SEC-03 | تشفير البيانات الحساسة | فحص قاعدة البيانات | تشفير البيانات الحساسة |

## 5. اختبارات الأداء (Performance Tests)

### 5.1 معالجة الصفقات المتعددة

- **الهدف**: التحقق من قدرة النظام على معالجة صفقات متعددة بكفاءة.
- **الأدوات**: أدوات قياس الأداء واختبارات الحمل.
- **الاختبارات**:

| رقم الاختبار | وصف الاختبار | المدخلات | النتيجة المتوقعة |
|-------------|-------------|---------|-----------------|
| PERF-01 | استيراد 100 صفقة | 100 صفقة جديدة | استيراد الصفقات بكفاءة |
| PERF-02 | إنشاء 50 شحنة متزامنة | 50 طلب | إنشاء الشحنات بكفاءة |
| PERF-03 | تحديث 200 شحنة | 200 شحنة | تحديث الشحنات بكفاءة |

## 6. اختبارات واجهة المستخدم (UI Tests)

### 6.1 واجهة الإدارة

- **الهدف**: التحقق من سهولة استخدام واجهة الإدارة.
- **الأدوات**: اختبارات يدوية أو Selenium.
- **الاختبارات**:

| رقم الاختبار | وصف الاختبار | المدخلات | النتيجة المتوقعة |
|-------------|-------------|---------|-----------------|
| UI-01 | إنشاء شركة شحن | بيانات شركة شحن | إنشاء الشركة بنجاح |
| UI-02 | إنشاء حساب شحن | بيانات حساب | إنشاء الحساب بنجاح |
| UI-03 | عرض قائمة الطلبات | تصفية حسب الحالة | عرض الطلبات المصفاة |
| UI-04 | عرض تفاصيل الشحنة | النقر على شحنة | عرض التفاصيل بنجاح |

## 7. اختبارات القبول (Acceptance Tests)

### 7.1 متطلبات العمل

- **الهدف**: التحقق من تلبية النظام لمتطلبات العمل.
- **الأدوات**: اختبارات يدوية مع المستخدمين النهائيين.
- **الاختبارات**:

| رقم الاختبار | وصف الاختبار | المدخلات | النتيجة المتوقعة |
|-------------|-------------|---------|-----------------|
| AC-01 | استيراد صفقات من Bitrix24 | إعداد التكامل | استيراد الصفقات بنجاح |
| AC-02 | إرسال طلب شحن إلى SMSA | طلب جديد | إرسال الشحنة بنجاح |
| AC-03 | تتبع حالة الشحنة | شحنة موجودة | عرض حالة الشحنة المحدثة |
| AC-04 | إدارة SKUs | إضافة SKU جديد | استخدام SKU في الشحنات |

## ملاحظات عامة

- يجب تنفيذ جميع الاختبارات في بيئة تجريبية (Staging) قبل النشر للإنتاج.
- استخدام حسابات API تجريبية لشركات الشحن لتجنب إنشاء شحنات حقيقية أثناء الاختبار.
- توثيق جميع الأخطاء المكتشفة بدقة وإصلاحها قبل الانتقال للإنتاج.
- التركيز على اختبار معالجة أرقام الهاتف وSKUs المنتجات، لأنها من أهم متطلبات النظام.